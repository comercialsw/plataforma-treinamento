<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartWay | Login</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="login-container">
    <img src="logo-smartway.jpg" alt="Logo SmartWay" class="logo" />
    <h2>Acesso à Plataforma</h2>

    <input id="email"    type="email"    placeholder="E-mail" required />
    <input id="password" type="password" placeholder="Senha" required />

    <button onclick="login()">Entrar</button>
    <button onclick="register()" class="outline">Primeiro acesso</button>
    <p id="error" class="error"></p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
    import {
      getFirestore,
      doc,
      setDoc
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    // Config Firebase
    const firebaseConfig = {
      apiKey:            'AIzaSyCTJ1qxAmxW8tksXBi8hFLchSnuvSAYQfY',
      authDomain:        'smartway-treinamentos.firebaseapp.com',
      projectId:         'smartway-treinamentos',
      storageBucket:     'smartway-treinamentos.appspot.com',
      messagingSenderId: '389500401009',
      appId:             '1:389500401009:web:22182df458fc133cc072d0'
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Persistência de sessão
    setPersistence(auth, browserLocalPersistence);

    // Expor funções globalmente
    window.login = async () => {
      const errEl = document.getElementById('error');
      errEl.textContent = '';
      try {
        await signInWithEmailAndPassword(
          auth,
          document.getElementById('email').value.trim(),
          document.getElementById('password').value
        );
        window.location.href = 'dashboard.html';
      } catch (e) {
        errEl.textContent = 'Usuário ou senha inválidos.';
      }
    };

    window.register = async () => {
      const errEl = document.getElementById('error');
      errEl.textContent = '';
      const email = document.getElementById('email').value.trim();
      const pwd   = document.getElementById('password').value;
      if (!email || !pwd) {
        errEl.textContent = 'Preencha e-mail e senha.';
        return;
      }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pwd);
        await setDoc(doc(db, 'progresso', cred.user.uid), {
          email:                cred.user.email,
          assistidos:           [],
          categorias_concluidas: [],
          certificado_emitido:  false,
          data_certificado:     null
        });
        window.location.href = 'dashboard.html';
      } catch (e) {
        errEl.textContent = 'Erro no cadastro: ' + e.message;
      }
    };

    // Se já está logado, ir direto ao dashboard
    onAuthStateChanged(auth, user => {
      if (user) window.location.replace('dashboard.html');
    });
  </script>
</body>
</html>

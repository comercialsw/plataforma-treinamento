<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard – SmartWay</title>

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Topo ---------------------------------------------------------->
  <header class="topbar">
    <img src="logo-smartway.jpg" alt="Logo SmartWay" class="logo-topo" />
    <select id="categoriaSelect"></select>
    <button id="btnLogout">Sair</button>
  </header>

  <!-- Conteúdo ------------------------------------------------------>
  <main>
    <div id="video-container" class="video-container"></div>
  </main>

  <!-- Firebase & lógica -------------------------------------------->
  <script type="module">
    /* 1) IMPORTS – SDK atualizado p/ 11.27.0 ---------------------- */
    import { initializeApp }               from 'https://www.gstatic.com/firebasejs/11.27.0/firebase-app.js';
    import { getAuth,
             onAuthStateChanged,
             signOut }                     from 'https://www.gstatic.com/firebasejs/11.27.0/firebase-auth.js';
    import { initializeFirestore,
             doc, getDoc,
             updateDoc, arrayUnion }       from 'https://www.gstatic.com/firebasejs/11.27.0/firebase-firestore.js';

    /* 2) CONFIGURAÇÃO (copie do Console Firebase) ----------------- */
    const firebaseConfig = {
      apiKey:            'SUA_API_KEY',
      authDomain:        'SEU_PROJETO.firebaseapp.com',
      projectId:         'SEU_PROJETO',
      storageBucket:     'SEU_PROJETO.appspot.com',
      messagingSenderId: 'SEU_SENDER_ID',
      appId:             'SEU_APP_ID'
    };

    /* 3) INICIALIZAÇÃO ------------------------------------------- */
    const app  = initializeApp(firebaseConfig);

    // Force long-polling → evita erro 400/ABORTED em hosts estáticos
    const db   = initializeFirestore(app, { experimentalForceLongPolling: true });
    const auth = getAuth(app);

    /* 4) Lista de vídeos (exemplo) -------------------------------- */
    const videos = [
      { id: 'IbthtipprPs', titulo: 'Segurança', categoria: 'Apresentação Modelos' },
      { id: '4dkCJjV0d6Y', titulo: 'Dicas',      categoria: 'Dicas Smartway' }
    ];

    /* 5) Referências de DOM -------------------------------------- */
    const container       = document.getElementById('video-container');
    const categoriaSelect = document.getElementById('categoriaSelect');
    const btnLogout       = document.getElementById('btnLogout');

    let userUID    = null;
    let assistidos = [];

    /* 6) Autenticação & carregamento ----------------------------- */
    onAuthStateChanged(auth, async user => {
      if (!user) {               // não logado → volta ao login
        window.location.replace('index.html');
        return;
      }

      userUID = user.uid;

      /* -- progresso -------- */
      const ref  = doc(db, 'progresso', userUID);
      const snap = await getDoc(ref);
      assistidos = snap.exists() ? snap.data().assistidos : [];

      /* -- categorias -------- */
      const categorias = [...new Set(videos.map(v => v.categoria))];
      categoriaSelect.innerHTML = '<option value="todos">Todas</option>';
      categorias.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        categoriaSelect.appendChild(opt);
      });

      categoriaSelect.addEventListener('change', () => {
        const filtro = categoriaSelect.value;
        const lista  = filtro === 'todos' ? videos
                                          : videos.filter(v => v.categoria === filtro);
        render(lista);
      });

      /* -- logout ------------ */
      btnLogout.addEventListener('click', () => {
        signOut(auth).then(() => window.location.replace('index.html'));
      });

      /* -- exibe tudo ao entrar */
      render(videos);
    });

    /* 7) Renderização -------------------------------------------- */
    function render(lista) {
      container.innerHTML = '';
      lista.forEach(v => {
        const visto = assistidos.includes(v.id);

        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <h3>${v.titulo}</h3>
          <iframe
            src="https://www.youtube.com/embed/${v.id}"
            loading="lazy"
            allowfullscreen>
          </iframe>
          <button ${visto ? 'disabled' : ''} onclick="marcar('${v.id}', this)">
            ${visto ? '✔ Assistido' : '✅ Marcar como assistido'}
          </button>
        `;
        container.appendChild(card);
      });
    }

    /* 8) Marca como assistido e salva ---------------------------- */
    window.marcar = async (id, btn) => {
      try {
        await updateDoc(doc(db, 'progresso', userUID), { assistidos: arrayUnion(id) });
        btn.textContent = '✔ Assistido';
        btn.disabled = true;
        assistidos.push(id);
      } catch (err) {
        console.error('Falha ao gravar progresso:', err);
      }
    };
  </script>
</body>
</html>
